name: Deploy to EC2 via SSM

on:
  push:
    branches: ["main"] # main에 push될 때마다 자동 배포

# ✅ OIDC 토큰 발급 권한 (없으면 자격증명 로드 실패함)
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) GitHub OIDC로 AWS Role을 Assume 해서 임시 자격증명 발급
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }} # GitHub Secret에 넣은 Role ARN
          aws-region: ap-northeast-2                 # 서울 리전 고정

      # 2) SSM으로 EC2에 쉘 명령 실행
      #    - /var/www/portfolio/deploy.sh 가 EC2에 존재해야 함
      #    - deploy.sh 내부에서 git pull/build/nginx reload 등을 수행
      - name: Run deploy script on EC2 (SSM)
        shell: bash
        run: |
          set -euo pipefail

          # (중요) SSM RunShellScript 문서로 명령 실행 요청
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=instanceIds,Values=${{ secrets.EC2_INSTANCE_ID }}" \
            --parameters commands=["/var/www/portfolio/deploy.sh"] \
            --query "Command.CommandId" \
            --output text)

          echo "SSM CommandId: $COMMAND_ID"

          # 명령이 끝날 시간을 약간 주고 결과 조회
          sleep 5

          # 표준 출력 확인(배포 로그가 여기 찍힘)
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --query "StandardOutputContent" \
            --output text

          # 표준 에러도 함께 확인하고 싶으면 아래 주석 해제
          # aws ssm get-command-invocation \
          #   --command-id "$COMMAND_ID" \
          #   --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
          #   --query "StandardErrorContent" \
          #   --output text
